<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Attendance Sheet + Instructor Panel</title>
  <link href="https://fonts.googleapis.com/css2?family=Lato:wght@400;700;900&display=swap" rel="stylesheet" />
  <style>
    html,body{
      margin:0;padding:0;height:100%;
      font-family:'Lato',sans-serif;
      background:linear-gradient(70deg,rgba(61,110,53,1),rgba(14,75,100,1));
      color:#fff;overflow:hidden;
    }
    body{display:flex;flex-direction:column;align-items:center;height:100vh;padding:20px;box-sizing:border-box;overflow:hidden}

    .logo{max-width:30%;height:auto;margin:20px 0 40px}
    .breadcrumb{margin-bottom:20px;font-size:16px;font-weight:bold;color:#fff}
    .breadcrumb span{cursor:pointer;text-decoration:underline;color:#cdebf5}
    .breadcrumb span:hover{color:#fff}

    .venue-message,.day-message{font-size:18px;font-weight:500;color:#fff;margin-bottom:20px;transition:.6s}
    .venue-message.hidden,.day-message.hidden{opacity:0;pointer-events:none;height:0;margin:0;overflow:hidden}

    .button-section{display:flex;flex-direction:column;align-items:stretch;gap:12px;width:100%;max-width:600px;height:70vh;overflow-y:auto;padding-right:5px}
    .button-section::-webkit-scrollbar{width:40px}
    .button-section::-webkit-scrollbar-thumb{background:url('Picture1.png') no-repeat center center;background-size:contain;border-radius:10px;border:none}

    .modal-content::-webkit-scrollbar,.panel-content::-webkit-scrollbar{width:40px}
    .modal-content::-webkit-scrollbar-thumb,.panel-content::-webkit-scrollbar-thumb{background:url('Picture1.png') no-repeat center center;background-size:contain;border-radius:10px;border:none}

    .filter-button{padding:10px 16px;background:#fff;color:#144F5F;border:none;border-radius:6px;cursor:pointer;font-weight:600;font-size:14px;width:100%;max-height:48px;text-align:left}
    .filter-button:hover{background:#144F5F;color:#fff}
    #backButton{padding:8px 16px;font-size:14px;max-width:150px;background:#fff;color:#144F5F;border:none;border-radius:6px;cursor:pointer;font-weight:600;margin-bottom:20px}
    #backButton:hover{background:#144F5F;color:#fff}
    .hidden{display:none}

    .modal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.5);justify-content:center;align-items:center;z-index:1000}
    .modal-content{background:#fff;color:#0E4B64;padding:20px;border-radius:10px;max-width:90%;width:900px;max-height:90vh;overflow-y:auto;box-shadow:0 4px 15px rgba(0,0,0,.3)}
    .modal-close{float:right;font-size:20px;cursor:pointer}

    table{width:100%;border-collapse:collapse;margin-top:12px;font-size:14px;color:#0E4B64;border:1px solid #cdebf5}
    th,td{border:1px solid #cdebf5;padding:10px;vertical-align:top;background:#fff}
    th{color:#0E4B64;font-weight:800;text-align:left;width:25%}

    .panel{position:fixed;right:16px;bottom:16px;width:360px;background:#fff;color:#0E4B64;border-radius:16px;box-shadow:0 10px 28px rgba(0,0,0,.35);overflow:hidden;display:none;z-index:1200;transition:all .3s}
    .panel.minimized{width:300px;height:50px}
    .panel.maximized{width:500px;max-height:80vh}
    .panel-header{display:flex;justify-content:space-between;align-items:center;background:#0E4B64;color:#fff;padding:8px 12px;font-weight:800}
    .panel-header-buttons{display:flex;gap:8px}
    .panel-header-buttons button{background:none;border:none;color:#fff;font-weight:bold;cursor:pointer;font-size:16px;padding:0 4px}
    .panel-content{padding:12px;overflow-y:auto;max-height:58vh}
    .panel.minimized .panel-content{display:none}

    .panel-hero{display:flex;align-items:center;gap:12px;margin-bottom:12px}
    .panel-hero img{width:72px;height:72px;border-radius:50%;object-fit:cover;border:3px solid #cdebf5}
    .who{font-size:16px;font-weight:900}
    .muted{font-size:12px;color:#517b89;font-weight:700}
    .chip{display:inline-block;border-radius:999px;margin:3px 5px 0 0;font-weight:700;background:#e6f6fb;color:#0E4B64;transform:scale(0.85);font-size:11px;opacity:0;animation:growWave .6s ease forwards;padding:4px 8px}
    @keyframes growWave{0%{transform:scale(.85);opacity:0}60%{transform:scale(1.08);opacity:1}100%{transform:scale(1);opacity:1}}

    .collapsible-title{font-size:13px;font-weight:500;color:#0E4B64;margin-top:8px;margin-bottom:6px;cursor:pointer;transition:color .3s ease}
    .collapsible-title:hover{color:#155d78}
    .collapsible-content{max-height:0;overflow:hidden;transition:max-height .4s ease}
    .collapsible-content.active{max-height:500px}
    
    .loading{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);font-size:20px;font-weight:bold}
    .error-message{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:rgba(255,0,0,0.9);color:#fff;padding:20px;border-radius:10px;max-width:80%;text-align:center}
    
    #instructorPoolContent::-webkit-scrollbar{width:40px}
    #instructorPoolContent::-webkit-scrollbar-thumb{background:url('Picture1.png') no-repeat center center;background-size:contain;border-radius:10px;border:none}
    
    #instructorPoolBtn:hover{background:#144F5F;color:#fff;transform:scale(1.05);transition:all 0.2s}
    
    #instructorSearch:focus{outline:none;border-color:#0E4B64;box-shadow:0 0 0 3px rgba(14,75,100,0.1)}
  </style>
</head>
<body>
  <div id="loadingMessage" class="loading">‚è≥ Loading data...</div>
  <img src="SGS_Academy_Logo_White.png" class="logo hidden" alt="Logo" id="logo">
  
  <!-- Instructor Pool Button -->
  <button id="instructorPoolBtn" class="hidden" onclick="showInstructorPool()" style="position:fixed;top:20px;right:20px;padding:10px 20px;background:#fff;color:#144F5F;border:none;border-radius:8px;cursor:pointer;font-weight:700;font-size:14px;box-shadow:0 4px 10px rgba(0,0,0,0.2);z-index:999">
    üë• Our Instructors
  </button>
  
  <div id="venueMessage" class="venue-message hidden">üìç Please choose a venue to continue</div>
  <div id="dayMessage" class="day-message hidden">üìÖ Please choose a day to continue</div>
  <div id="breadcrumb" class="breadcrumb hidden"></div>
  <button id="backButton" class="hidden" onclick="goBack()">‚Üê Back</button>
  <div class="button-section hidden" id="venueButtons"></div>
  <div class="button-section hidden" id="dayButtons"></div>
  <div class="button-section hidden" id="classButtons"></div>

  <div class="modal" id="classModal">
    <div class="modal-content">
      <span class="modal-close" onclick="closeModal()">&times;</span>
      <div id="classDetails"></div>
    </div>
  </div>

  <!-- Instructor Pool Modal -->
  <div class="modal" id="instructorPoolModal">
    <div class="modal-content" style="max-width:1000px">
      <span class="modal-close" onclick="closeInstructorPool()">&times;</span>
      <div style="text-align:center;margin-bottom:20px">
        <img src="SGS_Academy_Logo_Blue.png" alt="Logo" style="max-height:60px;margin-bottom:10px;" onerror="this.style.display='none'">
        <h2 style="color:#144F5F;margin:10px 0">üë• Our Instructors</h2>
        <p style="color:#517b89;font-size:14px">All available instructors </p>
      </div>
      
      <!-- Search Box -->
      <div style="margin-bottom:20px">
        <input type="text" id="instructorSearch" placeholder="üîç Search instructors by name or course..." 
          style="width:100%;padding:12px;border:2px solid #cdebf5;border-radius:6px;font-size:14px;box-sizing:border-box"
          onkeyup="filterInstructors()">
      </div>
      
      <!-- Stats -->
      <div id="instructorStats" style="display:flex;gap:15px;margin-bottom:20px;flex-wrap:wrap"></div>
      
      <!-- Instructor Grid -->
      <div id="instructorPoolContent" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:15px;max-height:60vh;overflow-y:auto"></div>
    </div>
  </div>

  <div id="instructorPanel" class="panel">
    <div class="panel-header">
      <span id="panelTitle">Instructor</span>
      <div class="panel-header-buttons">
        <button onclick="toggleMinimize()" id="minimizeBtn">‚àí</button>
        <button onclick="toggleMaximize()" id="maximizeBtn">‚ñ°</button>
        <button onclick="closePanel()">‚úï</button>
      </div>
    </div>
    <div id="panelContent" class="panel-content"></div>
  </div>

  <!-- Load instructors first -->
  <script src="./instructors.js"></script>

  <script>
    var scheduleData = {};
    var selectedVenue = '';
    var selectedDate = '';
    var currentLevel = 'venue';
    var allInstructors = []; // Store processed instructor data

    // ========== INSTRUCTOR POOL FUNCTIONS ==========
    
    function showInstructorPool() {
      var modal = document.getElementById('instructorPoolModal');
      if (!window.instructorsMap) {
        alert('Instructor data not loaded');
        return;
      }
      
      // Prepare instructor data
      allInstructors = [];
      for (var name in window.instructorsMap) {
        var info = window.instructorsMap[name];
        allInstructors.push({
          name: name,
          photo: info.photo || 'defaultInstructor.png',
          role: info.role || 'Instructor',
          authorized_for: info.authorized_for || [],
          searchText: (name + ' ' + (info.authorized_for || []).join(' ')).toLowerCase()
        });
      }
      
      // Sort by name
      allInstructors.sort(function(a, b) {
        return a.name.localeCompare(b.name);
      });
      
      renderInstructorPool();
      updateInstructorStats();
      modal.style.display = 'flex';
      
      // Focus search box
      setTimeout(function() {
        document.getElementById('instructorSearch').focus();
      }, 100);
    }
    
    function closeInstructorPool() {
      document.getElementById('instructorPoolModal').style.display = 'none';
      document.getElementById('instructorSearch').value = '';
    }
    
    function updateInstructorStats() {
      var total = allInstructors.length;
      var totalCourses = 0;
      var courseSet = {};
      
      for (var i = 0; i < allInstructors.length; i++) {
        var courses = allInstructors[i].authorized_for;
        totalCourses += courses.length;
        for (var j = 0; j < courses.length; j++) {
          courseSet[courses[j]] = true;
        }
      }
      
      var uniqueCourses = Object.keys(courseSet).length;
      var avgCourses = total > 0 ? Math.round(totalCourses / total) : 0;
      
      document.getElementById('instructorStats').innerHTML = 
        '<div style="flex:1;background:#e6f6fb;padding:12px;border-radius:6px;text-align:center">' +
        '<div style="font-size:24px;font-weight:900;color:#0E4B64">' + total + '</div>' +
        '<div style="font-size:12px;color:#517b89;font-weight:600">Total Instructors</div>' +
        '</div>' +
        '<div style="flex:1;background:#e6f6fb;padding:12px;border-radius:6px;text-align:center">' +
        '<div style="font-size:24px;font-weight:900;color:#0E4B64">' + uniqueCourses + '</div>' +
        '<div style="font-size:12px;color:#517b89;font-weight:600"> Courses</div>' +
        '</div>' +
        '<div style="flex:1;background:#e6f6fb;padding:12px;border-radius:6px;text-align:center">' +
        '<div style="font-size:24px;font-weight:900;color:#0E4B64">' + avgCourses + '</div>' +
        '<div style="font-size:12px;color:#517b89;font-weight:600">Avger Courses per Instructor/Instructor</div>' +
        '</div>';
    }
    
    function renderInstructorPool(filteredList) {
      var list = filteredList || allInstructors;
      var container = document.getElementById('instructorPoolContent');
      
      if (list.length === 0) {
        container.innerHTML = '<div style="grid-column:1/-1;text-align:center;padding:40px;color:#517b89">' +
          'üòî No instructors found matching your search</div>';
        return;
      }
      
      var html = '';
      for (var i = 0; i < list.length; i++) {
        var inst = list[i];
        var courseCount = inst.authorized_for.length;
        
        html += 
          '<div style="background:#fff;border:2px solid #cdebf5;border-radius:8px;padding:15px;cursor:pointer;transition:all 0.2s" ' +
          'onmouseover="this.style.borderColor=\'#0E4B64\';this.style.boxShadow=\'0 4px 12px rgba(0,0,0,0.1)\'" ' +
          'onmouseout="this.style.borderColor=\'#cdebf5\';this.style.boxShadow=\'none\'" ' +
          'onclick="openInstructorPanel(\'' + inst.name.replace(/'/g, "\\'") + '\')">' +
          
          '<div style="display:flex;align-items:center;gap:12px;margin-bottom:12px">' +
          '<img src="' + inst.photo + '" style="width:60px;height:60px;border-radius:50%;object-fit:cover;border:3px solid #cdebf5" ' +
          'onerror="this.src=\'defaultInstructor.png\'">' +
          '<div style="flex:1">' +
          '<div style="font-weight:900;color:#0E4B64;font-size:14px;margin-bottom:4px">' + toCamelCase(inst.name) + '</div>' +
          '<div style="font-size:11px;color:#517b89;font-weight:600">' + inst.role + '</div>' +
          '</div>' +
          '</div>' +
          
          '<div style="text-align:center;background:#e6f6fb;padding:8px;border-radius:6px">' +
          '<div style="font-size:20px;font-weight:900;color:#0E4B64">' + courseCount + '</div>' +
          '<div style="font-size:10px;color:#517b89;font-weight:600">CERTIFIED COURSES</div>' +
          '</div>' +
          
          '</div>';
      }
      
      container.innerHTML = html;
    }
    
    function filterInstructors() {
      var searchText = document.getElementById('instructorSearch').value.toLowerCase().trim();
      
      if (!searchText) {
        renderInstructorPool();
        return;
      }
      
      var filtered = [];
      for (var i = 0; i < allInstructors.length; i++) {
        if (allInstructors[i].searchText.indexOf(searchText) !== -1) {
          filtered.push(allInstructors[i]);
        }
      }
      
      renderInstructorPool(filtered);
    }
    
    // ========== END INSTRUCTOR POOL FUNCTIONS ==========

    // Universal data loader - tries multiple methods
    function loadJSON(callback) {
      console.log('üîÑ Attempting to load attendance_data.json...');
      
      // Method 1: Try fetch first (modern browsers)
      if (typeof fetch !== 'undefined') {
        console.log('üì° Trying fetch API...');
        fetch('attendance_data.json?v=' + Date.now())
          .then(function(response) {
            if (!response.ok) throw new Error('HTTP ' + response.status);
            return response.json();
          })
          .then(function(data) {
            console.log('‚úÖ Fetch successful! Data loaded.');
            callback(null, data);
          })
          .catch(function(err) {
            console.warn('‚ö†Ô∏è Fetch failed:', err.message);
            tryXHR();
          });
      } else {
        console.log('‚ö†Ô∏è Fetch not available, trying XHR...');
        tryXHR();
      }
      
      // Method 2: XMLHttpRequest (older browsers, MagicInfo)
      function tryXHR() {
        if (typeof XMLHttpRequest === 'undefined') {
          console.error('‚ùå No XMLHttpRequest available');
          callback(new Error('Cannot load data - no method available'));
          return;
        }
        
        console.log('üì° Trying XMLHttpRequest...');
        var xhr = new XMLHttpRequest();
        xhr.open('GET', 'attendance_data.json?v=' + Date.now(), true);
        xhr.timeout = 10000;
        
        xhr.onload = function() {
          if (xhr.status === 200) {
            try {
              var data = JSON.parse(xhr.responseText);
              console.log('‚úÖ XHR successful! Data loaded.');
              callback(null, data);
            } catch (e) {
              console.error('‚ùå JSON parse error:', e);
              callback(e);
            }
          } else {
            console.error('‚ùå XHR HTTP error:', xhr.status);
            callback(new Error('HTTP ' + xhr.status));
          }
        };
        
        xhr.onerror = function() {
          console.error('‚ùå XHR network error');
          callback(new Error('Network error - file not found or blocked'));
        };
        
        xhr.ontimeout = function() {
          console.error('‚ùå XHR timeout');
          callback(new Error('Request timeout'));
        };
        
        xhr.send();
      }
    }

    // Initialize
    function init() {
      console.log('üöÄ App initializing...');
      
      // Check instructors
      if (!window.instructorsMap) {
        console.error('‚ùå instructors.js not loaded!');
        showError('Error: instructors.js file not found or failed to load.<br>Please ensure it\'s in the same folder.');
        return;
      }
      
      var instructorCount = Object.keys(window.instructorsMap).length;
      console.log('‚úÖ Instructors loaded:', instructorCount, 'instructors in pool');
      console.log('üìã Instructor names:', Object.keys(window.instructorsMap).join(', '));
      
      // Count total certifications
      var totalCerts = 0;
      for (var key in window.instructorsMap) {
        var auth = window.instructorsMap[key].authorized_for || [];
        totalCerts += auth.length;
      }
      console.log('üìú Total certifications in pool:', totalCerts);
      
      // Load attendance data
      loadJSON(function(err, data) {
        if (err) {
          console.error('‚ùå Failed to load data:', err);
          showError('Error loading attendance_data.json:<br>' + err.message + '<br><br>Please ensure the file is in the same folder as this HTML file.');
          return;
        }
        
        if (!data || typeof data !== 'object') {
          console.error('‚ùå Invalid data format');
          showError('Error: attendance_data.json contains invalid data');
          return;
        }
        
        scheduleData = data;
        console.log('‚úÖ Schedule data loaded:', Object.keys(scheduleData).length, 'dates');
        
        // Hide loading, show app
        document.getElementById('loadingMessage').style.display = 'none';
        document.getElementById('logo').classList.remove('hidden');
        document.getElementById('venueMessage').classList.remove('hidden');
        document.getElementById('venueButtons').classList.remove('hidden');
        document.getElementById('instructorPoolBtn').classList.remove('hidden');
        
        rebuildVenueButtons();
        console.log('‚úÖ App ready!');
      });
    }

    function showError(msg) {
      var loading = document.getElementById('loadingMessage');
      if (loading) loading.style.display = 'none';
      
      var errorDiv = document.createElement('div');
      errorDiv.className = 'error-message';
      errorDiv.innerHTML = '<h2>‚ö†Ô∏è Loading Error</h2><p>' + msg + '</p>';
      document.body.appendChild(errorDiv);
    }

    function rebuildVenueButtons() {
      var venues = [];
      var venueSeen = {};
      
      for (var date in scheduleData) {
        var dayData = scheduleData[date];
        for (var classId in dayData.classes) {
          var cls = dayData.classes[classId];
          var v = (cls.venue || '').trim() || 'Unassigned Venue';
          cls.venue = v;
          if (!venueSeen[v]) {
            venues.push(v);
            venueSeen[v] = true;
          }
        }
      }
      
      venues.sort();
      var vEl = document.getElementById('venueButtons');
      vEl.innerHTML = '';
      
      console.log('üè¢ Found', venues.length, 'venues:', venues);
      
      for (var i = 0; i < venues.length; i++) {
        var v = venues[i];
        var b = document.createElement('button');
        b.className = 'filter-button';
        b.textContent = v;
        b.onclick = (function(venue) {
          return function() { showDaysForVenue(venue); };
        })(v);
        vEl.appendChild(b);
      }
    }

    function showDaysForVenue(v) {
      selectedVenue = v;
      currentLevel = 'day';
      selectedDate = '';
      
      document.getElementById('venueButtons').classList.add('hidden');
      document.getElementById('dayButtons').classList.remove('hidden');
      document.getElementById('backButton').classList.remove('hidden');
      document.getElementById('venueMessage').classList.add('hidden');
      document.getElementById('dayMessage').classList.remove('hidden');
      
      var dayB = document.getElementById('dayButtons');
      dayB.innerHTML = '';
      
      for (var date in scheduleData) {
        var info = scheduleData[date];
        var has = false;
        
        for (var classId in info.classes) {
          if (info.classes[classId].venue === v) {
            has = true;
            break;
          }
        }
        
        if (has) {
          var b = document.createElement('button');
          b.className = 'filter-button';
          b.textContent = date + ' - ' + info.day;
          b.onclick = (function(d) {
            return function() { showClassesOnDay(d); };
          })(date);
          dayB.appendChild(b);
        }
      }
    }

    function showClassesOnDay(d) {
      currentLevel = 'class';
      selectedDate = d;
      
      document.getElementById('dayButtons').classList.add('hidden');
      document.getElementById('classButtons').classList.remove('hidden');
      document.getElementById('dayMessage').classList.add('hidden');
      
      var cB = document.getElementById('classButtons');
      cB.innerHTML = '';
      var info = scheduleData[d];
      
      for (var id in info.classes) {
        var cls = info.classes[id];
        if (cls.venue === selectedVenue) {
          var b = document.createElement('button');
          b.className = 'filter-button';
          b.textContent = cls.title;
          b.onclick = (function(c, cid) {
            return function() { showClassDetails(c, cid); };
          })(cls, id);
          cB.appendChild(b);
        }
      }
    }

    function goBack() {
      if (currentLevel === 'class') {
        currentLevel = 'day';
        document.getElementById('classButtons').classList.add('hidden');
        document.getElementById('dayButtons').classList.remove('hidden');
        document.getElementById('dayMessage').classList.remove('hidden');
      } else if (currentLevel === 'day') {
        currentLevel = 'venue';
        document.getElementById('dayButtons').classList.add('hidden');
        document.getElementById('venueButtons').classList.remove('hidden');
        document.getElementById('backButton').classList.add('hidden');
        document.getElementById('venueMessage').classList.remove('hidden');
        document.getElementById('dayMessage').classList.add('hidden');
      }
    }

    function toCamelCase(str) {
      if (!str) return '';
      return str
        .toLowerCase()
        .split(/\s+/)
        .filter(function(w) { return w; })
        .map(function(w) { return w.charAt(0).toUpperCase() + w.slice(1); })
        .join(' ');
    }

    function showClassDetails(cls, id) {
      var students = cls.students || [];
      var emp = '';
      
      for (var i = 0; i < students.length; i++) {
        var s = students[i];
        var parts = [s["First Name"], s["Middle Name"], s["Last Name"]].filter(function(p) { return p; });
        var fullName = parts.join(" ");
        var formattedName = toCamelCase(fullName);
        emp += '<div><strong>' + s["User ID"] + '</strong> - ' + formattedName + '</div>';
      }
      
      var inst = cls.instructor || '';
      var link = inst
        ? '<a href="#" onclick="openInstructorPanel(\'' + inst.replace(/'/g, "\\'") + '\');return false;">' + toCamelCase(inst) + '</a>'
        : '';
        
      document.getElementById('classDetails').innerHTML = 
        '<div style="text-align:center;margin-bottom:10px;">' +
        '<img src="SGS_Academy_Logo_Blue.png" alt="Logo" style="max-height:60px;margin-bottom:10px;" onerror="this.style.display=\'none\'">' +
        '</div>' +
        '<h3 style="color:#144F5F;text-align:center;">' + cls.title + ' (ID: ' + id + ')</h3>' +
        '<table>' +
        '<tr><th>Instructor</th><td>' + link + '</td></tr>' +
        '<tr><th>Start Time</th><td>' + (cls.start_time || '') + '</td></tr>' +
        '<tr><th>End Time</th><td>' + (cls.end_time || '') + '</td></tr>' +
        '<tr><th>Venue</th><td>' + (cls.venue || '') + '</td></tr>' +
        '<tr><th>Employee Count</th><td>' + (cls.student_count || students.length) + '</td></tr>' +
        '<tr><th>Employees</th><td>' + emp + '</td></tr>' +
        '</table>';
        
      document.getElementById('classModal').style.display = 'flex';
    }

    function closeModal() {
      document.getElementById('classModal').style.display = 'none';
    }

    function normSlug(s) {
      if (!s) return '';
      return s.toLowerCase()
        .replace(/\./g, '') // Remove periods (for initials like "A.")
        .replace(/,/g, '') // Remove commas
        .replace(/[^a-z0-9\s]/g, ' ')
        .replace(/\s+/g, ' ')
        .trim();
    }

    function tokenize(s) {
      var tokens = normSlug(s).split(' ').filter(function(t) { return t.length > 0; });
      // Remove single letter tokens (middle initials) for better matching
      return tokens.filter(function(t) { return t.length > 1; });
    }

    function findBestInstructor(name) {
      var map = window.instructorsMap || {};
      var keys = Object.keys(map);
      
      if (keys.length === 0) {
        console.warn('‚ö†Ô∏è No instructors in pool');
        return null;
      }
      
      var qSlug = normSlug(name);
      var qTokens = tokenize(name);
      
      console.log('üîç Searching for instructor:', name);
      console.log('   Normalized:', qSlug);
      console.log('   Tokens:', qTokens);
      
      // 1. Exact match (normalized, ignoring middle initials)
      for (var i = 0; i < keys.length; i++) {
        var kSlug = normSlug(keys[i]);
        if (kSlug === qSlug) {
          console.log('‚úÖ Exact match found:', keys[i]);
          return { key: keys[i], info: map[keys[i]], score: 100 };
        }
      }
      
      // 2. Token-based matching (handles name variations and middle initials)
      var bestMatch = null;
      var bestScore = 0;
      
      for (var i = 0; i < keys.length; i++) {
        var key = keys[i];
        var kSlug = normSlug(key);
        var kTokens = tokenize(key);
        var score = 0;
        
        console.log('   Checking:', key, '| tokens:', kTokens);
        
        // Count matching tokens
        var matchedTokens = 0;
        var totalTokens = Math.max(qTokens.length, kTokens.length);
        
        for (var j = 0; j < qTokens.length; j++) {
          var qToken = qTokens[j];
          var bestTokenMatch = 0;
          
          for (var k = 0; k < kTokens.length; k++) {
            var kToken = kTokens[k];
            
            // Exact token match
            if (qToken === kToken) {
              bestTokenMatch = 1;
              break;
            }
            
            // Very close match (like "musthafa" vs "mustafa")
            if (qToken.length >= 4 && kToken.length >= 4) {
              var minLen = Math.min(qToken.length, kToken.length);
              var maxLen = Math.max(qToken.length, kToken.length);
              var matches = 0;
              
              for (var c = 0; c < minLen; c++) {
                if (qToken[c] === kToken[c]) matches++;
              }
              
              var similarity = matches / maxLen;
              if (similarity >= 0.8) { // 80% similar
                bestTokenMatch = Math.max(bestTokenMatch, similarity);
              }
            }
            
            // Partial match (first 4 chars for longer names)
            if (qToken.length >= 4 && kToken.length >= 4 &&
                qToken.substring(0, 4) === kToken.substring(0, 4)) {
              bestTokenMatch = Math.max(bestTokenMatch, 0.7);
            }
          }
          
          matchedTokens += bestTokenMatch;
        }
        
        if (matchedTokens > 0) {
          score = (matchedTokens / totalTokens) * 100;
          
          // Bonus for matching first and last names
          if (qTokens.length >= 2 && kTokens.length >= 2) {
            if (qTokens[0] === kTokens[0]) score += 5; // First name match
            if (qTokens[qTokens.length - 1] === kTokens[kTokens.length - 1]) score += 10; // Last name match
          }
          
          console.log('   Score:', score.toFixed(1));
        }
        
        if (score > bestScore) {
          bestScore = score;
          bestMatch = { key: key, info: map[key], score: score };
        }
      }
      
      // Accept matches with score >= 60
      if (bestMatch && bestScore >= 60) {
        console.log('‚úÖ Best match found:', bestMatch.key, '(score:', bestScore.toFixed(1) + ')');
        return bestMatch;
      }
      
      console.warn('‚ö†Ô∏è No good match found for:', name, '(best score:', bestScore ? bestScore.toFixed(1) : '0' + ')');
      console.log('üí° Top 5 instructors in pool:', keys.slice(0, 5).join(', '));
      return null;
    }

    function openInstructorPanel(rawName) {
      var p = document.getElementById('instructorPanel');
      var t = document.getElementById('panelTitle');
      var c = document.getElementById('panelContent');

      var match = findBestInstructor(rawName);
      var displayName = match ? match.key : toCamelCase(rawName);

      p.classList.remove('minimized', 'maximized');
      t.textContent = 'Our Instructor: ' + displayName;

      if (!match) {
        c.innerHTML = 
          '<div class="panel-hero">' +
          '<img src="defaultInstructor.png" onerror="this.src=\'data:image/svg+xml,%3Csvg xmlns=\'http://www.w3.org/2000/svg\' width=\'72\' height=\'72\'%3E%3Ccircle cx=\'36\' cy=\'36\' r=\'36\' fill=\'%23ccc\'/%3E%3C/svg%3E\'">' +
          '<div>' +
          '<div class="who">' + displayName + '</div>' +
          '<div class="muted">No profile found.</div>' +
          '</div>' +
          '</div>';
      } else {
        var info = match.info;
        var ph = info.photo || 'defaultInstructor.png';
        var role = info.role || '';
        var auth = info.authorized_for || [];
        
        // Sort certifications by length (shortest to longest)
        auth.sort(function(a, b) {
          return a.length - b.length;
        });
        
        var chips = '';
        
        for (var i = 0; i < auth.length; i++) {
          chips += '<span class="chip" style="animation-delay:' + (i * 0.1) + 's">' + auth[i] + '</span> ';
        }
        
        c.innerHTML = 
          '<div class="panel-hero">' +
          '<img src="' + ph + '" onerror="this.src=\'defaultInstructor.png\'">' +
          '<div>' +
          '<div class="who">' + displayName + '</div>' +
          '<div class="muted">' + role + '</div>' +
          '</div>' +
          '</div>' +
          (chips ? '<div>' +
          '<div class="collapsible-title" onclick="toggleCollapsible(this)">Certified to teach ‚ñæ</div>' +
          '<div class="collapsible-content">' + chips + '</div>' +
          '</div>' : '');
      }
      
      p.style.display = 'block';
    }

    function toggleCollapsible(title) {
      var content = title.nextElementSibling;
      var isActive = content.classList.contains('active');
      
      if (isActive) {
        content.classList.remove('active');
        title.innerHTML = 'Certified to teach ‚ñæ';
      } else {
        content.classList.add('active');
        title.innerHTML = 'Certified to teach ‚ñ¥';
      }
    }

    function closePanel() {
      document.getElementById('instructorPanel').style.display = 'none';
    }

    function toggleMinimize() {
      document.getElementById('instructorPanel').classList.toggle('minimized');
    }

    function toggleMaximize() {
      document.getElementById('instructorPanel').classList.toggle('maximized');
    }

    // Start app when ready
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', init);
    } else {
      init();
    }
  </script>
</body>
</html>
